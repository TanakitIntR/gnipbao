var Thread=function(c,a,g,f,i,b,e,h,d){this.xpo0=this.xp0=c;this.ypo0=this.yp0=a;this.xpo1=this.xp1=g;this.ypo1=this.yp1=f;this.xo;this.yo;this.pt0;this.pt1;this.pto0=new Point(this.xpo0,this.ypo0);this.pto1=new Point(this.xpo1,this.ypo1);this.xMid;this.yMid;this.xc;this.yc;this.xg;this.yg;this.xgi;this.ygi;this.xg1;this.yg1;this.xg0;this.yg0;this.xd;this.yd;this.dx;this.dy;this.rBezier=0.45;this.rDistMax=0.15;this.rDistMin=0.01;this.rAmpMax=0.072;this.ampPxMin=12;this.ampPxMax=33;this.pan0=-1;this.pan1=1;this.freq0=0.5;this.freq1=2.5;this.freq;this.ampDamp0=0.95;this.ampDamp1=0.87;this.ampDamp;this.len0=30;this.len1=650;this.distMax;this.distPerp;this.distInstantPerp=6;this.rGrab;this.rHalf;this.ang;this.angPerp;this.len;this.rStretch=0;this.route=h;this.dx0;this.dy0;this.dx1;this.dy1;this.dist0;this.dist1;this.dxBez0;this.dyBez0;this.dxBez1;this.dyBez1;this.ind=e;this.str0=1;this.str1=4;this.str=i;this.hex=b;this.ctGrab=0;this.t=0;this.amp;this.ampMax;this.rStrength;this.t0Snd;this.t1Snd;this.pitchInd;this.rPitch;this.vol0=0.3;this.vol1=0.5;this.vol0Car=0.2;this.vol1Car=0.55;this.isUpdOn=false;this.oscDir;this.isGrabbed=false;this.isOsc=false;this.isFirstOsc=false;this.isMidDraw=false;this.isVisible=false;this.car=null;this.carGrab=null;this.isFirstRun=true;this.arrIntersect=new Array();this.didInitIntersect=false;this.init();};Thread.prototype.init=function(){this.m=m;this.updPos();this.setSound();this.cv=this.m.cv1;};Thread.prototype.updPos=function(){if(this.car!=null){if(this.car.isFw){this.xp1=this.car.xp1;this.yp1=this.car.yp1;}else{this.xp0=this.car.xp1;this.yp0=this.car.yp1;}if(isNaN(this.xp1)){return;}}this.pt0=new Point(this.xp0,this.yp0);this.pt1=new Point(this.xp1,this.yp1);this.dx=this.xp1-this.xp0;this.dy=this.yp1-this.yp0;this.xMid=this.xp0+this.dx*0.5;this.yMid=this.yp0+this.dy*0.5;this.ang=Math.atan2(this.dy,this.dx);this.angPerp=Math.PI/2-this.ang;this.len=Math.sqrt(this.dx*this.dx+this.dy*this.dy);if(this.len>this.len1){this.rPitch=0;}else{if(this.len<this.len0){this.rPitch=1;}else{this.rPitch=1-norm(this.len,this.len0,this.len1);}}this.xc=this.xMid;this.yc=this.yMid;this.distMax=this.rDistMax*this.len;if(this.distMax>this.ampPxMax){this.distMax=this.ampPxMax;}else{if(this.distMax<this.ampPxMin){this.distMax=this.ampPxMin;}}this.freq=lerp(this.freq0,this.freq1,this.rPitch);this.ampDamp=lerp(this.ampDamp0,this.ampDamp1,this.rPitch);this.ampMax=this.rAmpMax*this.len;if(this.ampMax<this.ampPxMin){this.ampMax=this.ampPxMin;}else{if(this.ampMax>this.ampPxMax){this.ampMax=this.ampPxMax;}}if(this.isFirstRun){this.lenOrig=this.len;this.angOrig=this.ang;this.route.addToLength(this.len);this.isFirstRun=false;}};Thread.prototype.setSound=function(){this.pitchInd=Math.floor(this.rPitch*(this.m.notes-0.0001));this.arrNoteStr=["do","re","mi","fa","so","la","ti"];this.pitchStr=this.arrNoteStr[this.pitchInd%this.arrNoteStr.length];};Thread.prototype.redraw=function(){this.xo=this.m.xo;this.yo=this.m.yo;if(isNaN(this.xp1)){return;}if(this.isGrabbed||this.isFirstOsc){this.xd=this.xg;this.yd=this.yg;}else{this.xd=this.xc;this.yd=this.yc;}if(isNaN(this.xd)){return;}this.dx0=this.xd-this.xp0;this.dy0=this.yd-this.yp0;this.dx1=this.xp1-this.xd;this.dy1=this.yp1-this.yd;this.dist0=Math.sqrt(this.dx0*this.dx0+this.dy0*this.dy0);this.dist1=Math.sqrt(this.dx1*this.dx1+this.dy1*this.dy1);this.cv.beginPath();this.cv.lineCap="round";this.cv.strokeStyle=this.route.hexCurr;this.cv.lineWidth=this.str;this.dxBez0=this.rBezier*this.dist0*Math.cos(this.ang);this.dyBez0=this.rBezier*this.dist0*Math.sin(this.ang);this.dxBez1=this.rBezier*this.dist1*Math.cos(this.ang);this.dyBez1=this.rBezier*this.dist1*Math.sin(this.ang);this.cv.moveTo(this.xp0+this.xo,this.yp0+this.yo);this.cv.bezierCurveTo(this.xd-this.dxBez0+this.xo,this.yd-this.dyBez0+this.yo,this.xd+this.dxBez1+this.xo,this.yd+this.dyBez1+this.yo,this.xp1+this.xo,this.yp1+this.yo);this.cv.stroke();this.cv.closePath();};Thread.prototype.upd=function(){if(this.isGrabbed){this.updGrab();}else{if(this.isOsc){this.updOsc();}}if(this.isVisible){this.redraw();}};Thread.prototype.updOsc=function(){if(this.isFirstOsc){var f=0.8;var a=this.xg1-this.xg;var b=this.yg1-this.yg;this.xg+=a*f;this.yg+=b*f;if((Math.abs(a)<2)&&(Math.abs(b)<2)){this.t=0;this.oscDir=1;this.isFirstOsc=false;var e=sign(a);var d=sign(Math.sin(this.ang));if(e!=d){this.oscDir*=-1;}}}else{this.t+=this.freq*this.oscDir;var g=Math.sin(this.t);this.amp*=this.ampDamp;this.xc=this.xMid+g*Math.sin(this.ang)*this.amp;this.yc=this.yMid-g*Math.cos(this.ang)*this.amp;if(this.amp<0.5){this.amp=0;this.isOsc=false;}}};Thread.prototype.updGrab=function(){if(this.carGrab!=null){var b=this.carGrab.xp1;var h=this.carGrab.yp1;}else{var b=this.m.getUserX();var h=this.m.getUserY();}var i=b-this.xp0;var c=h-this.yp0;var g=Math.atan2(c,i);var e=this.ang-g;var d=Math.sqrt(i*i+c*c);this.distPerp=d*Math.sin(e);var f=d*Math.cos(e);this.rGrab=lim(f/this.len,0,1);if(this.rGrab<=0.5){this.rHalf=this.rGrab/0.5;}else{this.rHalf=1-(this.rGrab-0.5)/0.5;}var a=this.distMax*this.rHalf;this.rStrength=lim(Math.abs(this.distPerp)/this.distMax,0,1);if(Math.abs(this.distPerp)>a){this.m.dropThread(this);}else{this.xg=b;this.yg=h;}this.ctGrab++;};Thread.prototype.checkInstantGrab=function(){if(this.isGrabbed){return;}var a=this.m.getUserX();var b=this.m.getUserY();var e=a-this.xp0;var h=b-this.yp0;var f=Math.atan2(h,e);var d=this.ang-f;var g=Math.sqrt(e*e+h*h);this.distPerp=g*Math.sin(d);var c=g*Math.cos(d);this.rGrab=c/this.len;if((Math.abs(this.distPerp)<this.distInstantPerp)&&(this.rGrab>0)&&(this.rGrab<1)){this.m.grabThread(this,a,b,true,null);}};Thread.prototype.stopNote=function(){this.auObj.pause();};Thread.prototype.pluck=function(h,b,f,o){this.xgi=this.xg=h;this.ygi=this.yg=b;if(f){var d=this.m.getUserX();var n=this.m.getUserY();var l=this.m.getSpdAvg();}else{var d=o.getX();var n=o.getY();var l=0.1;}var p=d-this.xp0;var j=n-this.yp0;var i=this.xgi-this.xp0;var c=this.ygi-this.yp0;var k=Math.sqrt(p*p+j*j);this.rGrab=lim(k/this.len,0,1);if(this.rGrab<=0.5){this.rHalf=this.rGrab/0.5;}else{this.rHalf=1-(this.rGrab-0.5)/0.5;}var a=this.distMax*this.rHalf;this.distPerp=(1-l)*a;this.rStrength=lim(Math.abs(this.distPerp)/this.distMax,0,1);if(this.distPerp<this.ampPxMin){this.distPerp=this.ampPxMin;}this.xg=this.xgi+this.distPerp*Math.cos(this.angPerp);this.yg=this.ygi+this.distPerp*Math.sin(this.angPerp);this.xc=this.xMid;this.yc=this.yMid;if(this.isOsc){this.rStrength=lim((this.rStrength*0.5)+(this.amp/this.ampMax),0,1);this.amp=this.rStrength*this.ampMax;}else{this.amp=this.rStrength*this.ampMax;this.startOsc();}var g;if(f){g=lerp(this.vol0,this.vol1,this.rStrength);}else{g=lerp(this.vol0Car,this.vol1Car,this.rStrength);}var e=lerp(this.pan0,this.pan1,lim(d/this.m.width,0,1));this.playNote(g,e);};Thread.prototype.grab=function(c,d,b,a){if(b){this.carGrab=null;}else{this.carGrab=a;this.carGrab.thrGrab=this;}this.xgi=this.xg=c;this.ygi=this.yg=d;this.ctGrab=0;this.isGrabbed=true;this.updGrab();};Thread.prototype.drop=function(){this.isGrabbed=false;this.xc=this.xMid;this.yc=this.yMid;this.amp=this.rStrength*this.ampMax;if(this.carGrab!=null){var b=lerp(this.vol0Car,this.vol1Car,this.rStrength);this.carGrab.thrGrab=null;this.carGrab=null;}else{var b=lerp(this.vol0,this.vol1,this.rStrength);}var a=lim((this.xg+this.xo)/this.m.width,0,1);var c=lerp(this.pan0,this.pan1,a);this.playNote(b,c);this.startOsc();};Thread.prototype.startOsc=function(){this.xg1=this.xp0+this.rGrab*this.dx;this.yg1=this.yp0+this.rGrab*this.dy;this.xg0=this.xg;this.yg0=this.yg;t=0;this.isFirstOsc=this.isOsc=true;};Thread.prototype.playNote=function(a,b){smPlayNote(this.pitchInd,a,b);};Thread.prototype.setStretch=function(a){var b=this.r*this.distMax;this.xc=this.xMid+this.hyp*Math.cos(this.angPerp);this.yc=this.yMid+this.hyp*Math.sin(this.angPerp);};Thread.prototype.routeStartEnter=function(){this.isVisible=false;};Thread.prototype.carMoved=function(){this.updPos();this.setSound();};Thread.prototype.carStart=function(a){this.car=a;this.isVisible=true;this.isMidDraw=true;this.updPos();if(this.isOsc){}if(!this.didInitIntersect){this.initIntersect();}};Thread.prototype.initIntersect=function(){this.didInitIntersect=true;for(var e=0;e<this.m.arrRoutes.length;e++){rt=this.m.arrRoutes[e];if(this.route.ind==rt.ind){continue;}var a;var c;var d;for(var b=0;b<rt.arrThreads.length;b++){d=rt.arrThreads[b];var f=lineIntersect(this.pto0,this.pto1,d.pto0,d.pto1);if(f==null){continue;}a=f.x;c=f.y;if((!isNaN(a))&&(!isNaN(c))){this.arrIntersect.push(d);}}}};Thread.prototype.carDone=function(a){this.car=null;this.isMidDraw=false;this.xp1=this.xpo1;this.yp1=this.ypo1;this.xp0=this.xpo0;this.yp0=this.ypo0;this.updPos();this.setSound();};Thread.prototype.setMarked=function(){this.hex="#000000";};